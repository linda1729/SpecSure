# HybridSN CNN 模型实现日志

## 2025年11月28日 - HybridSN PyTorch 完整实现

### 实现功能

#### 1. 数据处理模块
- **多数据集支持**：实现了对 Indian Pines (IP)、Salinas (SA)、PaviaU (PU) 三个高光谱数据集的支持
- **数据加载**：从 .mat 文件加载高光谱数据和地面真值标签
- **PCA 降维**：使用主成分分析对高光谱数据进行降维处理（IP数据集默认30维，其他15维）
- **数据增强**：
  - 零填充（Zero Padding）实现边界处理
  - 图像立方体（Image Cubes）生成，支持可配置的窗口大小（默认25×25）
  - 自动去除零标签样本
- **数据集划分**：训练集/验证集/测试集按 7:3 比例分割，验证集从训练集中再按 1/3 分割

#### 2. 模型架构
- **HybridSN 网络**：实现了混合 3D-2D CNN 架构
  - 3个 3D 卷积层（8/16/32通道，核大小分别为7×3×3、5×3×3、3×3×3）
  - 1个 2D 卷积层（64通道，3×3核）
  - 3个全连接层（256→128→输出类别数）
  - Dropout 层（0.4）防止过拟合
- **动态层构建**：实现了首次前向传播时根据输入自动构建 conv2d 和 fc1 层的机制

#### 3. 训练功能
- **训练流程**：
  - 使用 Adam 优化器（学习率 1e-3）
  - 交叉熵损失函数
  - 指数学习率衰减（gamma=0.9）
  - 支持 GPU/CPU 自动选择
  - 批量大小可配置（默认256）
  - 训练轮数可配置（默认100轮）
- **模型保存**：
  - 基于验证集准确率保存最佳模型
  - 同时保存模型权重和 PCA 转换器
  - 保存训练元信息（K值、窗口大小、输出单元数等）
- **进度显示**：使用 tqdm 显示训练进度条

#### 4. 评估功能
- **多种评估指标**：
  - 总体准确率（Overall Accuracy, OA）
  - 平均准确率（Average Accuracy, AA）
  - Kappa 系数
  - 每类准确率
  - 混淆矩阵
  - 完整分类报告
- **测试集评估**：训练完成后自动在测试集上评估
- **结果保存**：将评估结果保存到 `classification_report_pytorch.txt`

#### 5. 推理功能
- **完整图像预测**：
  - 对整张高光谱图像进行逐像素分类
  - 自动跳过零标签像素
  - 使用训练时保存的 PCA 转换器
- **可视化输出**：
  - 生成预测结果可视化图（`predictions_pytorch.jpg`）
  - 生成地面真值可视化图（`{dataset}_ground_truth_pytorch.jpg`）
  - 使用 spectral 库的颜色映射
- **独立推理模式**：支持 `--inference_only` 参数仅执行推理而不训练

#### 6. 工具函数
- **路径解析**：自动解析数据目录路径
- **文件验证**：训练前验证所需数据文件是否存在
- **检查点管理**：模型和 PCA 的保存/加载机制
- **命令行接口**：丰富的 argparse 参数支持

#### 7. 命令行参数
支持的主要参数：
- `--dataset`：选择数据集（IP/SA/PU）
- `--window_size`：窗口大小（默认25）
- `--test_ratio`：测试集比例（默认0.3）
- `--epochs`：训练轮数（默认100）
- `--batch_size`：批量大小（默认256）
- `--lr`：学习率（默认1e-3）
- `--inference_only`：仅推理模式
- `--model_path`：模型保存路径
- `--data_path`：数据目录路径

### 技术特点

1. **完整的端到端流程**：从数据加载到模型训练、评估、推理、可视化全流程实现
2. **灵活的配置**：通过命令行参数支持多种配置组合
3. **健壮的错误处理**：数据文件验证、路径检查等
4. **可复现性**：固定随机种子（345）确保结果可复现
5. **模块化设计**：代码按功能分块组织清晰

### 下一步计划

#### 1. 可视化 Metrics
- [ ] 绘制混淆矩阵热力图

#### 2. 尝试学长多模态模型
- [ ] 研究学长的多模态融合方法

#### 3. 代码重构与模块化
- [ ] 将数据处理功能分离到 `data_utils.py`
- [ ] 将模型定义分离到 `models.py`
- [ ] 将训练/评估逻辑分离到 `train.py` 和 `eval.py`
- [ ] 创建 `metrics.py` 存放评估指标计算
- [ ] 创建 `visualization.py` 存放可视化功能
- [ ] 创建配置文件系统替代部分命令行参数

### 当前存在的问题

1. `eval_epoch` 函数中收集预测结果的代码位置需要修正（当前在循环外）
2. 代码过长，所有功能都在单文件中，需要模块化
3. 缺少训练过程的可视化
4. 没有早停（Early Stopping）机制

### 代码统计

- 总行数：约 400+ 行
- 主要依赖：PyTorch, scikit-learn, numpy, scipy, spectral, tqdm
- 支持数据集：3个（IP, SA, PU）
- 网络层数：7层（3×Conv3D + 1×Conv2D + 3×FC）
