# HybridSN CNN 模型实现日志

## 2025年12月8日 - 模块重构与功能增强

### 最近更新（第二阶段）

#### 1. 代码模块化重构
- **train_utils.py 拆分**：原单文件分离为两个专业模块：
  - `utils.py`：数据处理、训练工具、模型保存加载、类别名称加载（~400 行）
  - `visualization.py`：所有可视化函数（~150 行）
- **导入重构**：`train.py` 已更新，从 `utils` 和 `visualization` 分别导入对应功能
- **优势**：职责清晰，易于维护、测试和扩展

#### 2. CSV 类别名称自动加载
- **新增功能**：`utils.py` 中实现 `load_class_names(dataset, data_path)` 函数
- **工作流**：自动查找 `models/cnn/data/[Dataset]/[Dataset].CSV`，解析格式 `<class_id>,<class_name>`
- **集成**：训练/推理自动调用，将 `class_name_map` 传递给所有可视化函数
- **输出**：混淆矩阵坐标轴、图例自动显示人类可读类别名称（而非数字）

#### 3. 可视化增强
- **参数扩展**：所有可视化函数接受可选 `class_names` 参数
- **三类产物**：伪彩色图、分类图（带图例）、对比图（GT vs Pred）
- **自动名称**：若 CSV 存在，无需手动修改代码，所有图形自动使用中文/英文类别名称

## 2025年11月28日 - HybridSN PyTorch 完整实现

### 实现功能

#### 1. 数据处理模块
- **多数据集支持**：实现了对 Indian Pines (IP)、Salinas (SA)、PaviaU (PU) 三个高光谱数据集的支持
- **数据加载**：从 .mat 文件加载高光谱数据和地面真值标签
- **PCA 降维**：使用主成分分析对高光谱数据进行降维处理（IP数据集默认30维，其他15维）
- **数据增强**：
  - 零填充（Zero Padding）实现边界处理
  - 图像立方体（Image Cubes）生成，支持可配置的窗口大小（默认25×25）
  - 自动去除零标签样本
- **数据集划分**：训练集/验证集/测试集按 7:3 比例分割，验证集从训练集中再按 1/3 分割

#### 2. 模型架构
- **HybridSN 网络**：实现了混合 3D-2D CNN 架构
  - 3个 3D 卷积层（8/16/32通道，核大小分别为7×3×3、5×3×3、3×3×3）
  - 1个 2D 卷积层（64通道，3×3核）
  - 3个全连接层（256→128→输出类别数）
  - Dropout 层（0.4）防止过拟合
- **动态层构建**：实现了首次前向传播时根据输入自动构建 conv2d 和 fc1 层的机制

#### 3. 训练功能
- **训练流程**：
  - 使用 Adam 优化器（学习率 1e-3）
  - 交叉熵损失函数
  - 指数学习率衰减（gamma=0.9）
  - 支持 GPU/CPU 自动选择
  - 批量大小可配置（默认256）
  - 训练轮数可配置（默认100轮）
- **模型保存**：
  - 基于验证集准确率保存最佳模型
  - 同时保存模型权重和 PCA 转换器
  - 保存训练元信息（K值、窗口大小、输出单元数等）
- **进度显示**：使用 tqdm 显示训练进度条

#### 4. 评估功能
- **多种评估指标**：
  - 总体准确率（Overall Accuracy, OA）
  - 平均准确率（Average Accuracy, AA）
  - Kappa 系数
  - 每类准确率
  - 混淆矩阵
  - 完整分类报告
- **测试集评估**：训练完成后自动在测试集上评估
- **结果保存**：将评估结果保存到 `classification_report_pytorch.txt`

#### 5. 推理功能
- **完整图像预测**：
  - 对整张高光谱图像进行逐像素分类
  - 自动跳过零标签像素
  - 使用训练时保存的 PCA 转换器
- **可视化输出**：
  - 生成预测结果可视化图（`predictions_pytorch.jpg`）
  - 生成地面真值可视化图（`{dataset}_ground_truth_pytorch.jpg`）
  - 使用 spectral 库的颜色映射
- **独立推理模式**：支持 `--inference_only` 参数仅执行推理而不训练

#### 6. 工具函数
- **路径解析**：自动解析数据目录路径
- **文件验证**：训练前验证所需数据文件是否存在
- **检查点管理**：模型和 PCA 的保存/加载机制
- **命令行接口**：丰富的 argparse 参数支持

#### 7. 命令行参数
支持的主要参数：
- `--dataset`：选择数据集（IP/SA/PU）
- `--window_size`：窗口大小（默认25）
- `--test_ratio`：测试集比例（默认0.3）
- `--epochs`：训练轮数（默认100）
- `--batch_size`：批量大小（默认256）
- `--lr`：学习率（默认1e-3）
- `--inference_only`：仅推理模式
- `--model_path`：模型保存路径
- `--data_path`：数据目录路径

### 技术特点

1. **完整的端到端流程**：从数据加载到模型训练、评估、推理、可视化全流程实现
2. **灵活的配置**：通过命令行参数支持多种配置组合
3. **健壮的错误处理**：数据文件验证、路径检查等
4. **可复现性**：固定随机种子（345）确保结果可复现
5. **模块化设计**：代码按功能分块组织清晰

## 已完成任务清单

### 第二阶段成果（2025年12月8日）
- [x] 模块拆分：train_utils.py → utils.py + visualization.py
- [x] CSV 类别名称加载功能实现
- [x] 可视化函数参数化（接受 class_names）
- [x] train.py 导入更新，完整测试（Exit Code: 0）
- [x] README.md CSV 支持说明

### 第一阶段成果（2025年11月28日）
- [x] 绘制混淆矩阵热力图
- [x] 完整 HybridSN 模型训练流程
- [x] 多数据集支持（IP/SA/PU）
- [x] PCA 降维预处理
- [x] 模型保存/加载机制
- [x] 完整评估指标（OA/AA/Kappa）

## 当前存在的限制与观察

1. **可视化对比差异**：
   - `spectral.save_rgb`：基于原始 HSI 三个波段的物理 RGB 合成
   - `visualize_classification`：基于分类结果的语义颜色映射
   - 两者服务不同目的（图像显示 vs 结果呈现）

2. **缺失高级功能**：
   - 错误区域高亮（误分类像素标记）
   - 真值边界叠加（GT 轮廓在预测图上）
   - t-SNE 降维可视化
   - 早停策略（Early Stopping）

## 下一步计划

### 优先级列表（按重要性）

1. **【高】错误图绘制** 
   - 实现 `visualize_errors(pred, gt, class_names)` 函数
   - 高亮显示误分类像素
   - 统计各类别误分类率

2. **【高】前端集成**
   - 在 mockfrontend 展示新的可视化输出
   - 图片预览、参数调试界面
   - 与后端 FastAPI 通信

3. **【中】推理 API 接口**
   - `/api/predict` - 上传 HSI 文件并返回分类结果
   - 集成到 FastAPI 后端

4. **【中】文档更新**
   - 更新 STRUCTURE.md 反映新模块结构
   - 补充 CSV 格式说明

5. **【低】多模态融合**（未来方向）

### 模块代码统计（第二阶段）

| 模块 | 行数 | 职责 | 主要函数 |
|------|------|------|---------|
| utils.py | ~400 | 数据处理、训练、PCA、类别加载 | load_data, apply_pca, train_epoch, load_class_names |
| visualization.py | ~150 | 所有可视化产物 | visualize_classification, generate_all_visualizations |
| train.py | ~270 | 主训练/推理脚本 | main, train, test 函数，argparse 参数解析 |
| **总计** | **820+** | **完整端到端流程** | **7 层 HybridSN + 多种评估指标** |

**依赖库**：PyTorch, scikit-learn, numpy, scipy, spectral, tqdm, matplotlib, joblib

**数据集支持**：3 个（Indian Pines, Salinas, PaviaU）
